<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Grep - Instant Resource Search</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .code-snippet {
            background-color: #f6f8fa;
            border-radius: 3px;
            padding: 16px;
            overflow-x: auto;
            font-family: monospace;
        }
        .highlight {
            background-color: #fffbdd;
            font-weight: bold;
        }
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }
        @keyframes skeleton-loading {
            0% {
                background-color: hsl(200, 20%, 95%);
            }
            100% {
                background-color: hsl(200, 20%, 99%);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-indigo-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">Resource Grep</h1>
            <p class="text-indigo-200">Find the best programming resources instantly</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="mb-4 bg-blue-50 p-4 rounded-lg">
            <p class="text-blue-800">
                <strong>Note:</strong> The crawler is still collecting data. Currently, searching for "python" will show results. React-related content is being added.
            </p>
        </div>
        
        <div class="mb-8">
            <div class="flex">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Try searching for 'python tutorial' (currently has data)" 
                    class="w-full px-4 py-3 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                <button 
                    id="search-button" 
                    class="bg-indigo-600 text-white px-6 py-3 rounded-r-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                    Search
                </button>
            </div>
        </div>

        <!-- Status Stream - Hidden by default -->
        <div id="status-stream" class="mb-6 bg-gray-100 p-4 rounded-lg border border-gray-300 hidden">
            <h3 class="text-lg font-semibold mb-2 flex justify-between">
                <span>Processing Status</span>
                <button id="close-status" class="text-gray-500 hover:text-gray-700">Ã—</button>
            </h3>
            <div id="status-content" class="space-y-2">
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gray-300 mr-2"></div>
                    <span class="text-gray-600">Waiting for search...</span>
                </div>
            </div>
        </div>
        
        <div class="flex flex-wrap -mx-4">
            <!-- Filters -->
            <div class="w-full md:w-1/4 px-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold mb-4">Filters</h3>
                    
                    <div class="mb-4">
                        <h4 class="font-medium mb-2">Resource Type</h4>
                        <div id="type-filters" class="space-y-2">
                            <div class="skeleton h-6 w-full rounded"></div>
                            <div class="skeleton h-6 w-full rounded"></div>
                            <div class="skeleton h-6 w-full rounded"></div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">Language</h4>
                        <div id="language-filters" class="space-y-2">
                            <div class="skeleton h-6 w-full rounded"></div>
                            <div class="skeleton h-6 w-full rounded"></div>
                            <div class="skeleton h-6 w-full rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div class="w-full md:w-3/4 px-4">
                <div class="mb-4 flex justify-between items-center">
                    <div id="result-stats" class="text-gray-600">
                        Searching...
                    </div>
                    <div>
                        <select id="sort-select" class="border rounded p-2 text-sm">
                            <option value="relevance">Sort by: Relevance</option>
                            <option value="quality">Sort by: Quality</option>
                            <option value="date">Sort by: Date</option>
                        </select>
                    </div>
                </div>
                
                <div id="results-container" class="space-y-6">
                    <!-- Results will be populated here -->
                    <div class="skeleton h-32 w-full rounded-lg"></div>
                    <div class="skeleton h-32 w-full rounded-lg"></div>
                    <div class="skeleton h-32 w-full rounded-lg"></div>
                </div>
                
                <div id="pagination" class="mt-8 flex justify-center">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const resultsContainer = document.getElementById('results-container');
            const resultStats = document.getElementById('result-stats');
            const typeFilters = document.getElementById('type-filters');
            const languageFilters = document.getElementById('language-filters');
            const sortSelect = document.getElementById('sort-select');
            const pagination = document.getElementById('pagination');
            const statusStream = document.getElementById('status-stream');
            const statusContent = document.getElementById('status-content');
            const closeStatus = document.getElementById('close-status');
            
            let currentQuery = '';
            let currentFilters = {};
            let currentPage = 0;
            let currentSort = 'relevance';
            let searchTimeout;
            let webSocket = null;
            let resultsReceived = 0;
            let allResults = [];
            let statusMessages = [];
            
            // Initialize with a search input value but don't auto-search
            searchInput.value = 'python tutorial';
            
            // Close status button
            closeStatus.addEventListener('click', function() {
                statusStream.classList.add('hidden');
            });
            
            // Event listeners
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    currentPage = 0;
                    performSearch();
                }
            });
            
            searchButton.addEventListener('click', function() {
                currentPage = 0;
                performSearch();
            });
            
            sortSelect.addEventListener('change', function() {
                currentSort = sortSelect.value;
                // Re-sort the existing results
                sortResults();
            });
            
            function performSearch() {
                currentQuery = searchInput.value.trim();
                
                if (!currentQuery) {
                    return;
                }
                
                // Clear previous results
                resultsContainer.innerHTML = '';
                resultStats.textContent = 'Searching...';
                resultsReceived = 0;
                allResults = [];
                
                // Show status stream
                statusStream.classList.remove('hidden');
                addStatusUpdate(`Searching for: "${currentQuery}"`, 'info');
                
                // Close previous WebSocket connection if exists
                if (webSocket && webSocket.readyState !== WebSocket.CLOSED) {
                    webSocket.close();
                }
                
                // Show loading skeleton
                resultsContainer.innerHTML = `
                    <div class="skeleton h-32 w-full rounded-lg"></div>
                    <div class="skeleton h-32 w-full rounded-lg"></div>
                    <div class="skeleton h-32 w-full rounded-lg"></div>
                `;
                
                // Add search mode toggle after the search input
                const searchModeToggleId = 'search-mode-toggle';
                const existingToggle = document.getElementById(searchModeToggleId);
                
                if (!existingToggle) {
                    const toggleContainer = document.createElement('div');
                    toggleContainer.className = 'mt-2 flex justify-end';
                    toggleContainer.id = searchModeToggleId;
                    toggleContainer.innerHTML = `
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button id="http-mode" class="px-4 py-2 text-sm font-medium text-white bg-indigo-400 rounded-l-lg">
                                HTTP Search
                            </button>
                            <button id="ws-mode" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 active rounded-r-lg">
                                WebSocket (Live)
                            </button>
                        </div>
                    `;
                    
                    // Insert toggle after search input container
                    const searchInputContainer = document.querySelector('.mb-8');
                    searchInputContainer.after(toggleContainer);
                    
                    // Add event listeners to toggle buttons
                    document.getElementById('http-mode').addEventListener('click', function() {
                        if (webSocket && webSocket.readyState !== WebSocket.CLOSED) {
                            webSocket.close();
                        }
                        this.classList.remove('bg-indigo-400');
                        this.classList.add('bg-indigo-600', 'active');
                        document.getElementById('ws-mode').classList.remove('bg-indigo-600', 'active');
                        document.getElementById('ws-mode').classList.add('bg-indigo-400');
                        fallbackToRegularSearch();
                    });
                    
                    document.getElementById('ws-mode').addEventListener('click', function() {
                        this.classList.remove('bg-indigo-400');
                        this.classList.add('bg-indigo-600', 'active');
                        document.getElementById('http-mode').classList.remove('bg-indigo-600', 'active');
                        document.getElementById('http-mode').classList.add('bg-indigo-400');
                        const wsURL = getWebSocketURL();
                        connectWebSocket(wsURL);
                    });
                } else {
                    // If toggle already exists, set WebSocket mode as active by default
                    document.getElementById('ws-mode').classList.remove('bg-indigo-400');
                    document.getElementById('ws-mode').classList.add('bg-indigo-600', 'active');
                    document.getElementById('http-mode').classList.remove('bg-indigo-600', 'active');
                    document.getElementById('http-mode').classList.add('bg-indigo-400');
                }
                
                // First try a quick HTTP search to see if we already have results
                simulateSearchRequest(currentQuery)
                    .then(data => {
                        // If we have results, display them
                        renderResults(data);
                        
                        // If few results, also connect to WebSocket for live updates
                        if (data.total < 5) {
                            addStatusUpdate('Few results found, connecting to WebSocket for live updates...', 'info');
                            // Use WebSocket for real-time updates
                            const wsURL = getWebSocketURL();
                            connectWebSocket(wsURL);
                        } else {
                            addStatusUpdate(`Found ${data.total} results via HTTP search`, 'success');
                        }
                    })
                    .catch(error => {
                        console.error('HTTP search error:', error);
                        addStatusUpdate('HTTP search error, trying WebSocket instead...', 'warning');
                        
                        // Try WebSocket as fallback
                        const wsURL = getWebSocketURL();
                        connectWebSocket(wsURL);
                    });
            }
            
            function getWebSocketURL() {
                // Build WebSocket URL with query parameters
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname;
                const port = '8001'; // Streaming API port
                
                // Convert filters to JSON
                const filtersJson = JSON.stringify(currentFilters);
                
                // Create WebSocket URL
                return `${protocol}//${host}:${port}/ws/search?query=${encodeURIComponent(currentQuery)}&filters=${encodeURIComponent(filtersJson)}`;
            }
            
            function connectWebSocket(url) {
                try {
                    // Create WebSocket connection
                    addStatusUpdate('Connecting to WebSocket for live updates...', 'pending');
                    webSocket = new WebSocket(url);
                    
                    // Set a connection timeout
                    const connectionTimeout = setTimeout(() => {
                        if (webSocket.readyState !== WebSocket.OPEN) {
                            addStatusUpdate('WebSocket connection timeout. Falling back to HTTP search.', 'error');
                            webSocket.close();
                            fallbackToRegularSearch();
                        }
                    }, 5000); // 5 second timeout
                    
                    // Connection opened
                    webSocket.onopen = function(event) {
                        clearTimeout(connectionTimeout); // Clear the timeout
                        console.log("WebSocket connection established");
                        addStatusUpdate('WebSocket connected. Waiting for live results...', 'success');
                        
                        // Show that we're in WebSocket mode
                        resultStats.textContent = 'Using WebSocket for live search results...';
                        
                        // Clear loading skeletons
                        const skeletons = resultsContainer.querySelectorAll('.skeleton');
                        skeletons.forEach(skeleton => skeleton.remove());
                        
                        // Add info message if no results yet
                        if (resultsReceived === 0) {
                            resultsContainer.innerHTML = `
                                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                    <p class="text-gray-600">Searching for "${currentQuery}"</p>
                                    <p class="text-sm text-gray-500 mt-2">Results will appear here in real-time as they're found</p>
                                    <div class="mt-4">
                                        <div class="animate-pulse bg-blue-200 h-2 w-full rounded"></div>
                                    </div>
                                </div>
                            `;
                        }
                    };
                    
                    // Listen for messages
                    webSocket.onmessage = function(event) {
                        const message = JSON.parse(event.data);
                        console.log("WebSocket message:", message);
                        
                        handleStreamingMessage(message);
                    };
                    
                    // Handle errors
                    webSocket.onerror = function(error) {
                        clearTimeout(connectionTimeout); // Clear the timeout
                        console.error("WebSocket error:", error);
                        addStatusUpdate('WebSocket connection error. Retrying...', 'warning');
                        
                        // Try to reconnect once before falling back
                        setTimeout(() => {
                            try {
                                const wsURL = getWebSocketURL();
                                webSocket = new WebSocket(wsURL);
                                
                                // Set a second timeout for the retry
                                const retryTimeout = setTimeout(() => {
                                    if (webSocket.readyState !== WebSocket.OPEN) {
                                        addStatusUpdate('WebSocket retry timeout. Falling back to HTTP search.', 'error');
                                        webSocket.close();
                                        fallbackToRegularSearch();
                                    }
                                }, 5000);
                                
                                webSocket.onopen = function() {
                                    clearTimeout(retryTimeout);
                                    addStatusUpdate('WebSocket reconnected successfully!', 'success');
                                };
                                
                                webSocket.onerror = function() {
                                    clearTimeout(retryTimeout);
                                    // If second attempt fails, fall back to HTTP
                                    addStatusUpdate('WebSocket reconnection failed. Falling back to HTTP search.', 'error');
                                    fallbackToRegularSearch();
                                };
                            } catch (e) {
                                addStatusUpdate('WebSocket reconnection error. Falling back to HTTP search.', 'error');
                                fallbackToRegularSearch();
                            }
                        }, 1000);
                    };
                    
                    // Connection closed
                    webSocket.onclose = function(event) {
                        clearTimeout(connectionTimeout); // Clear the timeout
                        console.log("WebSocket connection closed", event);
                        
                        // Only show message if it wasn't our own closing and wasn't already handled by error handler
                        if (event.code !== 1000 && !event.wasClean) {
                            addStatusUpdate('WebSocket connection closed unexpectedly. Falling back to HTTP search.', 'warning');
                            fallbackToRegularSearch();
                        }
                    };
                } catch (error) {
                    console.error("Error creating WebSocket:", error);
                    addStatusUpdate('Error creating WebSocket connection. Falling back to HTTP search.', 'error');
                    
                    // Fall back to regular search
                    fallbackToRegularSearch();
                }
            }
            
            // Function to add status update
            function addStatusUpdate(message, type = 'info') {
                // Define colors based on type
                const colors = {
                    info: 'bg-blue-500',
                    success: 'bg-green-500',
                    warning: 'bg-yellow-500',
                    error: 'bg-red-500',
                    pending: 'bg-gray-300'
                };
                
                // Add message to the array
                statusMessages.push({ message, type, timestamp: new Date() });
                
                // Show the status stream if hidden
                statusStream.classList.remove('hidden');
                
                // Create status element
                const statusElement = document.createElement('div');
                statusElement.className = 'flex items-center animate-fadeIn';
                statusElement.innerHTML = `
                    <div class="w-4 h-4 rounded-full ${colors[type]} mr-2"></div>
                    <div class="flex-1">
                        <span class="text-gray-800">${message}</span>
                        <span class="text-gray-500 text-xs ml-2">${new Date().toLocaleTimeString()}</span>
                    </div>
                `;
                
                // Add to status content
                statusContent.appendChild(statusElement);
                
                // Auto-scroll to bottom
                statusContent.scrollTop = statusContent.scrollHeight;
                
                return statusElement;
            }
            
            // Modify handleStreamingMessage to update status
            function handleStreamingMessage(message) {
                // Clear loading skeletons on first message
                if (resultsReceived === 0) {
                    resultsContainer.innerHTML = '';
                }
                
                // Handle different message types
                switch (message.type) {
                    case 'stats':
                        resultStats.textContent = `Found ${message.data.total} results (${message.data.took}ms)`;
                        addStatusUpdate(`Search completed: Found ${message.data.total} results`, 'success');
                        
                        if (message.data.total === 0) {
                            resultsContainer.innerHTML = `
                                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                    <p class="text-gray-600">No results found for "${currentQuery}"</p>
                                    <p class="text-sm text-gray-500 mt-2">Starting a crawler to collect data for this query</p>
                                    <div class="mt-4">
                                        <div class="animate-pulse bg-blue-200 h-2 w-full rounded"></div>
                                    </div>
                                    <p class="text-gray-600 mt-4">Stay on this page to see results as they're found</p>
                                </div>
                            `;
                            addStatusUpdate('Starting crawler for new content...', 'info');
                        }
                        break;
                        
                    case 'result':
                        resultsReceived++;
                        const result = message.data;
                        
                        // Add to all results array for sorting
                        allResults.push(result);
                        
                        // Add result to the page
                        renderSingleResult(result);
                        
                        // Update status
                        if (resultsReceived === 1) {
                            addStatusUpdate('Receiving search results...', 'info');
                        }
                        
                        if (resultsReceived % 5 === 0) {
                            addStatusUpdate(`Received ${resultsReceived} results so far`, 'success');
                        }
                        break;
                        
                    case 'crawling':
                        // Add crawling status update
                        addStatusUpdate(`Crawler: ${message.data.message}`, 'info');
                        break;
                        
                    case 'processing':
                        // Add processing status update
                        addStatusUpdate(`Processing: ${message.data.message}`, 'info');
                        break;
                        
                    case 'indexing':
                        // Add indexing status update
                        addStatusUpdate(`Indexing: ${message.data.message}`, 'success');
                        break;
                        
                    case 'status':
                        // Show status message
                        console.log("Status:", message.data.message);
                        addStatusUpdate(`Status: ${message.data.message}`, 'info');
                        
                        // Update result count if necessary
                        if (resultsReceived === 0) {
                            resultStats.textContent = "No results found yet. Still searching...";
                            resultsContainer.innerHTML = `
                                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                    <p class="text-gray-600">No results found yet for "${currentQuery}"</p>
                                    <p class="text-sm text-gray-500 mt-2">We're still looking. Please wait...</p>
                                    <div class="mt-4">
                                        <div class="animate-pulse bg-gray-200 h-2 w-full rounded"></div>
                                    </div>
                                </div>
                            `;
                        }
                        break;
                        
                    case 'error':
                        console.error("Search error:", message.data.message);
                        resultStats.textContent = 'Search error';
                        addStatusUpdate(`Error: ${message.data.message}`, 'error');
                        resultsContainer.innerHTML = `
                            <div class="bg-red-100 text-red-700 p-4 rounded-lg">
                                <p>Error: ${message.data.message}</p>
                                <p class="mt-2 text-sm">Please try a different search query.</p>
                            </div>
                        `;
                        break;
                }
            }
            
            function renderSingleResult(result) {
                // Create result card
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md mb-4 animate-fadeIn';
                card.dataset.resultId = result.id;
                
                // Create type badge
                const typeBadge = document.createElement('span');
                typeBadge.className = `inline-block px-2 py-1 text-xs rounded-full mr-2 ${getTypeBadgeColor(result.type)}`;
                typeBadge.textContent = result.type;
                
                // Create language badge if available
                let langBadge = null;
                if (result.language) {
                    langBadge = document.createElement('span');
                    langBadge.className = `inline-block px-2 py-1 text-xs rounded-full ${getLanguageBadgeColor(result.language)}`;
                    langBadge.textContent = result.language;
                }
                
                // Add source badge (elasticsearch or realtime)
                const sourceBadge = document.createElement('span');
                sourceBadge.className = `inline-block px-2 py-1 text-xs rounded-full ml-2 ${result.source === 'realtime' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`;
                sourceBadge.textContent = result.source === 'realtime' ? 'New' : 'Indexed';
                
                // Build card content
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-semibold mb-2">
                            <a href="${result.url}" target="_blank" class="text-indigo-600 hover:text-indigo-800">${result.title}</a>
                        </h3>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-1">Relevance:</span>
                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${Math.min(100, (result.score / 10) * 100)}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-gray-500 text-sm mb-3">${result.url}</div>
                    <div class="mb-4">${result.description || 'No description available'}</div>
                    <div class="mb-2 badges"></div>
                `;
                
                // Add badges
                card.querySelector('.badges').appendChild(typeBadge);
                if (langBadge) card.querySelector('.badges').appendChild(langBadge);
                card.querySelector('.badges').appendChild(sourceBadge);
                
                // Add highlights if available
                if (result.highlight) {
                    const highlightsDiv = document.createElement('div');
                    highlightsDiv.className = 'mt-4 pt-4 border-t border-gray-200';
                    
                    if (result.highlight.content) {
                        const contentHighlight = document.createElement('div');
                        contentHighlight.className = 'mb-3';
                        contentHighlight.innerHTML = `
                            <div class="text-xs text-gray-500 mb-1">Content Preview:</div>
                            <div class="text-sm text-gray-700">${result.highlight.content[0]}</div>
                        `;
                        highlightsDiv.appendChild(contentHighlight);
                    }
                    
                    if (result.highlight.code_snippets && result.highlight.code_snippets.length > 0) {
                        const snippetHighlight = document.createElement('div');
                        snippetHighlight.className = 'mb-3';
                        snippetHighlight.innerHTML = `
                            <div class="text-xs text-gray-500 mb-1">Code Snippet:</div>
                            <pre class="code-snippet text-sm">${result.highlight.code_snippets[0]}</pre>
                        `;
                        highlightsDiv.appendChild(snippetHighlight);
                    }
                    
                    card.appendChild(highlightsDiv);
                }
                
                resultsContainer.appendChild(card);
            }
            
            function sortResults() {
                // Only sort if we have results
                if (!allResults || allResults.length === 0) {
                    return;
                }
                
                // Sort based on the current sort option
                allResults.sort((a, b) => {
                    switch (currentSort) {
                        case 'quality':
                            return (b.quality_score || 0) - (a.quality_score || 0);
                        case 'date':
                            // Parse dates or use current time as fallback
                            const dateA = a.timestamp ? new Date(a.timestamp) : new Date();
                            const dateB = b.timestamp ? new Date(b.timestamp) : new Date();
                            return dateB - dateA;
                        case 'relevance':
                        default:
                            // For relevance, we use the score
                            return (b.score || 0) - (a.score || 0);
                    }
                });
                
                // Re-render the results
                resultsContainer.innerHTML = '';
                allResults.forEach(result => renderSingleResult(result));
            }
            
            function fallbackToRegularSearch() {
                addStatusUpdate('Falling back to HTTP search...', 'info');
                
                // Make a regular HTTP request to the search API
                simulateSearchRequest(currentQuery)
                    .then(renderResults)
                    .catch(error => {
                        console.error('HTTP search error:', error);
                        addStatusUpdate('HTTP search error: ' + error.message, 'error');
                        
                        // Show error message in results container
                        resultsContainer.innerHTML = `
                            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                <p class="text-red-600">Error searching for "${currentQuery}"</p>
                                <p class="text-sm text-gray-500 mt-2">Please try again later</p>
                            </div>
                        `;
                    });
            }
            
            function simulateSearchRequest(query) {
                // Show loading state
                resultStats.textContent = 'Searching...';
                
                // Build the search URL with filters
                let searchUrl = `http://${window.location.hostname}:8000/search?q=${encodeURIComponent(query)}`;
                
                // Add filters if any
                if (currentFilters.type) {
                    searchUrl += `&type=${encodeURIComponent(currentFilters.type)}`;
                }
                if (currentFilters.language) {
                    searchUrl += `&language=${encodeURIComponent(currentFilters.language)}`;
                }
                
                // Add pagination
                searchUrl += `&page=${currentPage}&size=10`;
                
                // Make the actual fetch request
                return fetch(searchUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }
                        return response.json();
                    });
            }
            
            function renderResults(data) {
                // Handle case where data is undefined (No results found case)
                if (!data) {
                    return;
                }
                
                // Update result stats
                resultStats.textContent = `Found ${data.total || 0} results (${data.took || 0}ms)`;
                
                // Clear results and render hits
                resultsContainer.innerHTML = '';
                
                // Check if crawling was started due to no results
                if (data.crawling_started) {
                    const crawlingNotice = document.createElement('div');
                    crawlingNotice.className = 'bg-yellow-100 p-6 rounded-lg shadow-md text-center mb-6';
                    crawlingNotice.innerHTML = `
                        <p class="text-yellow-800">No existing results found for "${currentQuery}"</p>
                        <p class="text-sm text-yellow-700 mt-2">We've started crawling the web for this query. Results will appear here as they're found.</p>
                        <div class="mt-4">
                            <div class="animate-pulse bg-yellow-200 h-2 w-full rounded"></div>
                        </div>
                        <p class="text-xs text-yellow-600 mt-2">Try refreshing in a minute for new results or switch to WebSocket mode for live updates.</p>
                    `;
                    resultsContainer.appendChild(crawlingNotice);
                    
                    // Add button to switch to WebSocket mode for live updates
                    const liveUpdatesBtn = document.createElement('button');
                    liveUpdatesBtn.className = 'mt-4 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 focus:outline-none';
                    liveUpdatesBtn.textContent = 'Switch to Live Updates';
                    liveUpdatesBtn.addEventListener('click', function() {
                        // Close the WebSocket if it exists
                        if (webSocket && webSocket.readyState !== WebSocket.CLOSED) {
                            webSocket.close();
                        }
                        
                        // Connect to WebSocket for live updates
                        const wsURL = getWebSocketURL();
                        connectWebSocket(wsURL);
                    });
                    
                    crawlingNotice.appendChild(liveUpdatesBtn);
                    
                    // Set a timer to refresh results in 30 seconds
                    setTimeout(() => {
                        simulateSearchRequest(currentQuery)
                            .then(renderResults)
                            .catch(error => console.error('Auto-refresh error:', error));
                    }, 30000);
                }
                
                if (!data.hits || data.hits.length === 0) {
                    if (!data.crawling_started) {
                        resultsContainer.innerHTML = `
                            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                <p class="text-gray-600">No results found for "${currentQuery}"</p>
                                <p class="text-sm text-gray-500 mt-2">Try using different keywords or removing filters</p>
                            </div>
                        `;
                    }
                    return;
                }
                
                // Render the results
                data.hits.forEach(hit => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow-md';
    
    // Default values for missing fields
    const item = hit._source || hit;
    const quality_score = item.quality_score || 0.7;
    const language = item.language || item.languages?.[0] || "unknown";
    const type = item.type || "article";
    
    // Create badge for resource type
    const typeBadge = document.createElement('span');
    typeBadge.className = `inline-block px-2 py-1 text-xs rounded-full mr-2 ${getTypeBadgeColor(type)}`;
    typeBadge.textContent = type;
    
    // Create badge for language
    const langBadge = document.createElement('span');
    langBadge.className = `inline-block px-2 py-1 text-xs rounded-full ${getLanguageBadgeColor(language)}`;
    langBadge.textContent = language;
    
    // Build the card content
    card.innerHTML = `
        <div class="flex justify-between items-start">
            <h3 class="text-xl font-semibold mb-2">
                <a href="${item.url}" target="_blank" class="text-indigo-600 hover:text-indigo-800">${item.title}</a>
            </h3>
            <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-1">Quality:</span>
                <div class="w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" style="width: ${quality_score * 100}%"></div>
                </div>
            </div>
        </div>
        <div class="text-gray-500 text-sm mb-3">${item.url}</div>
        <div class="mb-4">${item.description || 'No description available'}</div>
        <div class="mb-2 badges"></div>
    `;
    
    // Add badges
    card.querySelector('.badges').appendChild(typeBadge);
    card.querySelector('.badges').appendChild(langBadge);
    
    // Add highlights if available
    if (hit.highlight) {
        const highlightsDiv = document.createElement('div');
        highlightsDiv.className = 'mt-4 pt-4 border-t border-gray-200';
        
        if (hit.highlight.content) {
            const contentHighlight = document.createElement('div');
            contentHighlight.className = 'mb-3';
            contentHighlight.innerHTML = `
                <div class="text-xs text-gray-500 mb-1">Content Preview:</div>
                <div class="text-sm text-gray-700">${hit.highlight.content[0]}</div>
            `;
            highlightsDiv.appendChild(contentHighlight);
        }
        
        if (hit.highlight.code_snippets && hit.highlight.code_snippets.length > 0) {
            const snippetHighlight = document.createElement('div');
            snippetHighlight.className = 'mb-3';
            snippetHighlight.innerHTML = `
                <div class="text-xs text-gray-500 mb-1">Code Snippet:</div>
                <pre class="code-snippet text-sm">${hit.highlight.code_snippets[0]}</pre>
            `;
            highlightsDiv.appendChild(snippetHighlight);
        }
        
        card.appendChild(highlightsDiv);
    }
    
    resultsContainer.appendChild(card);
});

// Handle facets for filters
const facets = {
    resource_types: [],
    languages: []
};

// If data.facets exists, use it; otherwise try to extract facets from aggregations
if (data.facets) {
    facets.resource_types = data.facets.resource_types || [];
    facets.languages = data.facets.languages || [];
} else if (data.aggregations) {
    // Convert Elasticsearch aggregations to our facet format
    if (data.aggregations.resource_types) {
        facets.resource_types = data.aggregations.resource_types.buckets || [];
    }
    if (data.aggregations.languages) {
        facets.languages = data.aggregations.languages.buckets || [];
    }
}

// Render filters
renderFilters(facets);

// Render pagination
renderPagination(data.total || 0);
}

function renderFilters(facets) {
    // Render resource type filters
    typeFilters.innerHTML = '';
    facets.resource_types.forEach(filter => {
        const filterItem = document.createElement('div');
        filterItem.className = 'flex items-center';
        filterItem.innerHTML = `
            <input type="radio" id="type-${filter.key}" name="type" value="${filter.key}" 
                ${currentFilters.type === filter.key ? 'checked' : ''} class="mr-2">
            <label for="type-${filter.key}" class="text-sm flex-1">${filter.key}</label>
            <span class="text-xs text-gray-500">(${filter.doc_count})</span>
        `;
        
        typeFilters.appendChild(filterItem);
        
        // Add event listener to filter
        filterItem.querySelector('input').addEventListener('change', function() {
            if (this.checked) {
                currentFilters.type = this.value;
            } else {
                delete currentFilters.type;
            }
            currentPage = 0;
            performSearch();
        });
    });
    
    // Add "All" option for resource type
    const allTypeFilter = document.createElement('div');
    allTypeFilter.className = 'flex items-center';
    allTypeFilter.innerHTML = `
        <input type="radio" id="type-all" name="type" value="" 
            ${!currentFilters.type ? 'checked' : ''} class="mr-2">
        <label for="type-all" class="text-sm flex-1">All Types</label>
    `;
    
    typeFilters.insertBefore(allTypeFilter, typeFilters.firstChild);
    
    allTypeFilter.querySelector('input').addEventListener('change', function() {
        if (this.checked) {
            delete currentFilters.type;
            currentPage = 0;
            performSearch();
        }
    });
    
    // Render language filters
    languageFilters.innerHTML = '';
    facets.languages.forEach(filter => {
        const filterItem = document.createElement('div');
        filterItem.className = 'flex items-center';
        filterItem.innerHTML = `
            <input type="radio" id="lang-${filter.key}" name="language" value="${filter.key}" 
                ${currentFilters.language === filter.key ? 'checked' : ''} class="mr-2">
            <label for="lang-${filter.key}" class="text-sm flex-1">${filter.key}</label>
            <span class="text-xs text-gray-500">(${filter.doc_count})</span>
        `;
        
        languageFilters.appendChild(filterItem);
        
        // Add event listener to filter
        filterItem.querySelector('input').addEventListener('change', function() {
            if (this.checked) {
                currentFilters.language = this.value;
            } else {
                delete currentFilters.language;
            }
            currentPage = 0;
            performSearch();
        });
    });
    
    // Add "All" option for language
    const allLangFilter = document.createElement('div');
    allLangFilter.className = 'flex items-center';
    allLangFilter.innerHTML = `
        <input type="radio" id="lang-all" name="language" value="" 
            ${!currentFilters.language ? 'checked' : ''} class="mr-2">
        <label for="lang-all" class="text-sm flex-1">All Languages</label>
    `;
    
    languageFilters.insertBefore(allLangFilter, languageFilters.firstChild);
    
    allLangFilter.querySelector('input').addEventListener('change', function() {
        if (this.checked) {
            delete currentFilters.language;
            currentPage = 0;
            performSearch();
        }
    });
}

function renderPagination(total) {
    const totalPages = Math.ceil(total / 10);
    pagination.innerHTML = '';
    
    if (totalPages <= 1) {
        return;
    }
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.className = `mx-1 px-3 py-1 rounded ${currentPage > 0 ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
    prevButton.textContent = 'Previous';
    prevButton.disabled = currentPage === 0;
    prevButton.addEventListener('click', function() {
        if (currentPage > 0) {
            currentPage--;
            performSearch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    pagination.appendChild(prevButton);
    
    // Page numbers
    const startPage = Math.max(0, currentPage - 2);
    const endPage = Math.min(totalPages - 1, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `mx-1 px-3 py-1 rounded ${i === currentPage ? 'bg-indigo-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
        pageButton.textContent = i + 1;
        pageButton.addEventListener('click', function() {
            currentPage = i;
            performSearch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        pagination.appendChild(pageButton);
    }
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.className = `mx-1 px-3 py-1 rounded ${currentPage < totalPages - 1 ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`;
    nextButton.textContent = 'Next';
    nextButton.disabled = currentPage >= totalPages - 1;
    nextButton.addEventListener('click', function() {
        if (currentPage < totalPages - 1) {
            currentPage++;
            performSearch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    pagination.appendChild(nextButton);
}

function getTypeBadgeColor(type) {
    const colors = {
        'tutorial': 'bg-blue-100 text-blue-800',
        'documentation': 'bg-green-100 text-green-800',
        'repository': 'bg-purple-100 text-purple-800',
        'article': 'bg-yellow-100 text-yellow-800'
    };
    
    return colors[type] || 'bg-gray-100 text-gray-800';
}

function getLanguageBadgeColor(language) {
    const colors = {
        'javascript': 'bg-yellow-100 text-yellow-800',
        'python': 'bg-blue-100 text-blue-800',
        'java': 'bg-orange-100 text-orange-800',
        'go': 'bg-teal-100 text-teal-800',
        'rust': 'bg-red-100 text-red-800',
        'php': 'bg-indigo-100 text-indigo-800',
        'ruby': 'bg-red-100 text-red-800',
        'c#': 'bg-purple-100 text-purple-800',
        'c++': 'bg-gray-100 text-gray-800'
    };
    
    return colors[language] || 'bg-gray-100 text-gray-800';
}

            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                currentPage = 0;
                performSearch();
            });
        });
    </script>
</body>
</html>